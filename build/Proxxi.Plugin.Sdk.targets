<Project>

  <PropertyGroup>
    <PluginSuffix>plugin</PluginSuffix>
    <PluginPackageExtension>pxp</PluginPackageExtension>
    <InternalDir>$(PublishDir)public/</InternalDir>
  </PropertyGroup>

  <Target Name="PackPlugin" DependsOnTargets="RenameMainDll;PrepareInternalFolder;ArchivePack" />

  <Target Name="RenameMainDll">
    <Move SourceFiles="$(PublishDir)$(AssemblyName).dll"
          DestinationFiles="$(PublishDir)$(AssemblyName).$(PluginSuffix).dll" />

    <Message Importance="high" Text="Renamed output to $(PublishDir)$(AssemblyName).$(PluginSuffix).dll" />
  </Target>

  <Target Name="PrepareInternalFolder">
    <Message Importance="high" Text="Organizing files into subfolder..." />

    <MakeDir Directories="$(InternalDir)" />

    <ItemGroup>
      <FilesToMove Include="$(PublishDir)**\*.*" Exclude="$(InternalDir)**\*.*" />
    </ItemGroup>

    <Move SourceFiles="@(FilesToMove)"
          DestinationFiles="@(FilesToMove->'$(InternalDir)%(RecursiveDir)%(Filename)%(Extension)')" />
  </Target>

  <Target Name="ArchivePack">
    <Message Importance="high" Text="Archiving publish output to tar.gz..." />

    <Exec Command="tar -czf &quot;$(PublishDir)$(AssemblyName).$(PluginPackageExtension)&quot; -C &quot;$(PublishDir)public/&quot; ." />

    <Message Importance="high" Text="Archive created at $(PublishDir)$(AssemblyName).$(PluginPackageExtension)" />
  </Target>

</Project>
